<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    <meta name="google-site-verification" content="GMEaPMDxu9wbSWV-Qv6QTCL6AihUyIGcwlEhQNo1dG4">
    
    
    
    <title>聊聊TCP中的KeepAlive机制 | 王爵的技术博客 | 一个后端程序员的笔记</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="tcp,keepalive">
    <meta name="description" content="服务端的系统设置中经常会和底层协议打交道，我们有必要重温一下曾经那些“听过”却不熟悉的名词。 今天聊的话题是 KeepAlive，在实际应用中又是怎么使用的？">
<meta name="keywords" content="tcp,keepalive">
<meta property="og:type" content="article">
<meta property="og:title" content="聊聊TCP中的KeepAlive机制">
<meta property="og:url" content="http://biezhi.me/2017/08/29/talk-tcp-keepalive.html">
<meta property="og:site_name" content="王爵的技术博客">
<meta property="og:description" content="服务端的系统设置中经常会和底层协议打交道，我们有必要重温一下曾经那些“听过”却不熟悉的名词。 今天聊的话题是 KeepAlive，在实际应用中又是怎么使用的？">
<meta property="og:image" content="http://biezhi.me/static/img/article/tcp-keepalive.png">
<meta property="og:image" content="https://i.loli.net/2017/08/29/59a5633379ed8.png">
<meta property="og:updated_time" content="2017-08-29T14:36:28.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="聊聊TCP中的KeepAlive机制">
<meta name="twitter:description" content="服务端的系统设置中经常会和底层协议打交道，我们有必要重温一下曾经那些“听过”却不熟悉的名词。 今天聊的话题是 KeepAlive，在实际应用中又是怎么使用的？">
<meta name="twitter:image" content="http://biezhi.me/static/img/article/tcp-keepalive.png">
    
        <link rel="alternate" type="application/atom+xml" title="王爵的技术博客" href="/atom.xml">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="/css/style.css?v=1.6.10">
    <script>window.lazyScripts=[]</script>
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.png">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">王爵nice</h5>
          <a href="mailto:biezhi.me@gmail.com" title="biezhi.me@gmail.com" class="mail">biezhi.me@gmail.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                归档
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/projects"  >
                <i class="icon icon-lg icon-cubes"></i>
                项目
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/books"  >
                <i class="icon icon-lg icon-book"></i>
                书籍
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/design"  >
                <i class="icon icon-lg icon-dribbble"></i>
                设计
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/link"  >
                <i class="icon icon-lg icon-link"></i>
                友链
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/about"  >
                <i class="icon icon-lg icon-leaf"></i>
                关于
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/biezhi" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">聊聊TCP中的KeepAlive机制</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">聊聊TCP中的KeepAlive机制</h1>
        <h5 class="subtitle">
            
                <time datetime="2017-08-28T16:00:00.000Z" itemprop="datePublished" class="page-time">
  2017-08-29
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/王爵的技术小黑屋/">王爵的技术小黑屋</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#为什么有Keepalive？"><span class="post-toc-number">1.</span> <span class="post-toc-text">为什么有Keepalive？</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#如何设置它"><span class="post-toc-number">2.</span> <span class="post-toc-text">如何设置它?</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#在Linux内核设置"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">在Linux内核设置</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#使用Netty4设置"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">使用Netty4设置</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#C语言设置"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">C语言设置</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#在Nginx中配置"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">在Nginx中配置</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#使用的场景"><span class="post-toc-number">3.</span> <span class="post-toc-text">使用的场景</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#和Http中Keep-Alive的关系"><span class="post-toc-number">4.</span> <span class="post-toc-text">和Http中Keep-Alive的关系</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#参考资料"><span class="post-toc-number">5.</span> <span class="post-toc-text">参考资料</span></a></li></ol>
        </nav>
    </aside>
    
<article id="post-talk-tcp-keepalive"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">聊聊TCP中的KeepAlive机制</h1>
        <div class="post-meta">
            <time class="post-time" title="2017-08-29 00:00:00" datetime="2017-08-28T16:00:00.000Z"  itemprop="datePublished">2017-08-29</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/王爵的技术小黑屋/">王爵的技术小黑屋</a></li></ul>



            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <p>服务端的系统设置中经常会和底层协议打交道，我们有必要重温一下曾经那些“听过”却不熟悉的名词。
今天聊的话题是 <code>KeepAlive</code>，在实际应用中又是怎么使用的？</p>
<a id="more"></a>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/static/img/article/tcp-keepalive.png" alt="wireshark抓包" width="650" height="340" title="">
                </div>
                <div class="image-caption">wireshark抓包</div>
            </figure>
<h2 id="为什么有Keepalive？"><a href="#为什么有Keepalive？" class="headerlink" title="为什么有Keepalive？"></a>为什么有Keepalive？</h2><!--
在现实生活中我们都知道如果一个女生追了你很久你都没有答应，那么要不这个女生会放弃要么你是个`Gay`。
但最终都会有一个答案的，总不能妹子倾其一生在追你~ 而你却迟迟不应（yìng），那妹子的大好青春都被毁了。
正常一点的情况是妹子追了你一个月发现不来电，马上把目光转向
-->
<p>大家都做过电梯吧，假设电梯来了你先进去，你朋友还没进来，过一段时间电梯门就会自动关闭，
你应该没遇到过哪个电梯会一直等你朋友来了才关门的。如果真是那样，那别的楼层的小姐姐们会炸了~</p>
<p>我们举个编程中的例子来解释下，我编写了一个服务端程序<code>S</code>和一个客户端程序<code>C</code>，客户端向服务端发送
一个消息：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://i.loli.net/2017/08/29/59a5633379ed8.png" alt="客户端发送消息" width="350" height="250" title="">
                </div>
                <div class="image-caption">客户端发送消息</div>
            </figure>
<p>服务端收到消息后一看，瞧给你牛*的，然后没理客户端，傻狗客户端一直在等待，但是不知道是不是服务器挂掉了？
这时候<code>TCP</code>协议提出一个办法，当客户端端等待超过一定时间后自动给服务端发送一个空的报文，
如果对方回复了这个报文证明连接还存活着，如果对方没有报文返回且进行了多次尝试都是一样，
那么就认为连接已经丢失，客户端就没必要继续保持连接了。
如果没有这种机制就会有很多空闲的连接占用着系统资源。</p>
<blockquote>
<p>KeepAlive并不是TCP协议规范的一部分，但在几乎所有的TCP/IP协议栈（不管是Linux还是Windows）中，都实现了KeepAlive功能</p>
</blockquote>
<p><a href="https://tools.ietf.org/html/rfc1122#page-101" target="_blank" rel="external">RFC1122#TCP Keep-Alives</a></p>
<h2 id="如何设置它"><a href="#如何设置它" class="headerlink" title="如何设置它?"></a>如何设置它?</h2><p>在设置之前我们先来看看<code>KeepAlive</code>都支持哪些设置项</p>
<ol>
<li>KeepAlive默认情况下是关闭的，可以被上层应用开启和关闭</li>
<li><code>tcp_keepalive_time</code>: KeepAlive的空闲时长，或者说每次正常发送心跳的周期，默认值为7200s（2小时）</li>
<li><code>tcp_keepalive_intvl</code>: KeepAlive探测包的发送间隔，默认值为75s</li>
<li><code>tcp_keepalive_probes</code>: 在tcp_keepalive_time之后，没有接收到对方确认，继续发送保活探测包次数，默认值为9（次）</li>
</ol>
<p>我们讲讲在Linux操作系统和使用Java、C语言和Nginx中如何设置</p>
<h3 id="在Linux内核设置"><a href="#在Linux内核设置" class="headerlink" title="在Linux内核设置"></a>在Linux内核设置</h3><p><code>KeepAlive</code>默认不是开启的，如果想使用<code>KeepAlive</code>，需要在你的应用中设置<code>SO_KEEPALIVE</code>才可以生效。</p>
<p>查看当前的配置：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">cat /proc/sys/net/ipv4/tcp_keepalive_time</div><div class="line">cat /proc/sys/net/ipv4/tcp_keepalive_intvl</div><div class="line">cat /proc/sys/net/ipv4/tcp_keepalive_probes</div></pre></td></tr></table></figure>
<p>在Linux中我们可以通过修改 <code>/etc/sysctl.conf</code> 的全局配置：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">net.ipv4.tcp_keepalive_time=7200</div><div class="line">net.ipv4.tcp_keepalive_intvl=75</div><div class="line">net.ipv4.tcp_keepalive_probes=9</div></pre></td></tr></table></figure>
<p>添加上面的配置后输入 <code>sysctl -p</code> 使其生效，你可以使用 <code>sysctl -a | grep keepalive</code> 命令来查看当前的默认配置</p>
<blockquote>
<p>如果应用中已经设置<code>SO_KEEPALIVE</code>，程序不用重启，内核直接生效</p>
</blockquote>
<h3 id="使用Netty4设置"><a href="#使用Netty4设置" class="headerlink" title="使用Netty4设置"></a>使用Netty4设置</h3><p>这里我们使用常用的Java网络框架Netty来设置，只需要在服务端设置即可：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">EventLoopGroup bossGroup   = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>);</div><div class="line">EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    ServerBootstrap b = <span class="keyword">new</span> ServerBootstrap();</div><div class="line">    b.group(bossGroup, workerGroup)</div><div class="line">            .channel(NioServerSocketChannel.class)</div><div class="line">            .option(ChannelOption.SO_BACKLOG, <span class="number">100</span>)</div><div class="line">            .childOption(ChannelOption.SO_KEEPALIVE, <span class="keyword">true</span>)</div><div class="line">            .handler(<span class="keyword">new</span> LoggingHandler(LogLevel.INFO));</div><div class="line"></div><div class="line">    <span class="comment">// Start the server.</span></div><div class="line">    ChannelFuture f = b.bind(<span class="number">8088</span>).sync();</div><div class="line">    <span class="comment">// Wait until the server socket is closed.</span></div><div class="line">    f.channel().closeFuture().sync();</div><div class="line">&#125; <span class="keyword">finally</span> &#123;</div><div class="line">    <span class="comment">// Shut down all event loops to terminate all threads.</span></div><div class="line">    bossGroup.shutdownGracefully();</div><div class="line">    workerGroup.shutdownGracefully();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这段代码来自经典的<code>echo</code>服务器，我们在<code>childOption</code>中开启了<code>SO_KEEPALIVE</code>。
Java程序只能做到设置<code>SO_KEEPALIVE</code>选项，其他配置项只能依赖于<code>sysctl</code>配置，系统进行读取。</p>
<h3 id="C语言设置"><a href="#C语言设置" class="headerlink" title="C语言设置"></a>C语言设置</h3><p>函数原型：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">setsockopt</span><span class="params">(<span class="keyword">int</span> socket, <span class="keyword">int</span> level, <span class="keyword">int</span> option_name,</span></span></div><div class="line">      <span class="keyword">const</span> <span class="keyword">void</span> *option_value, <span class="keyword">socklen_t</span> option_len);</div></pre></td></tr></table></figure>
<p>我们在需要使能<code>Keepalive</code>的<code>socket</code>上面调用<code>setsockopt</code>函数便可以打开该<code>socket</code>上面的<code>keepalive</code>。</p>
<ol>
<li>第一个参数是要设置的套接字</li>
<li>第二个参数是<code>SOL_SOCKET</code></li>
<li>第三个参数必须是<code>SO_KEEPALIVE</code></li>
<li>第四个参数必须是一个布尔整型值，0表示关闭，1表示打开</li>
<li>最后一个参数是第四个参数值的大小。</li>
</ol>
<p>调用例子：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">socket</span><span class="params">(<span class="keyword">int</span> domain, <span class="keyword">int</span> type, <span class="keyword">int</span> protocol)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">int</span> (*libc_socket)(<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>);</div><div class="line">  <span class="keyword">int</span> s, optval;</div><div class="line">  <span class="keyword">char</span> *env;</div><div class="line"></div><div class="line">  *(<span class="keyword">void</span> **)(&amp;libc_socket) = dlsym(RTLD_NEXT, <span class="string">"socket"</span>);</div><div class="line">  <span class="keyword">if</span>(dlerror()) &#123;</div><div class="line">    errno = EACCES;</div><div class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span>((s = (*libc_socket)(domain, type, protocol)) != <span class="number">-1</span>) &#123;</div><div class="line">    <span class="keyword">if</span>((domain == PF_INET) &amp;&amp; (type == SOCK_STREAM)) &#123;</div><div class="line">      <span class="keyword">if</span>(!(env = getenv(<span class="string">"KEEPALIVE"</span>)) || strcasecmp(env, <span class="string">"off"</span>)) &#123;</div><div class="line">        optval = <span class="number">1</span>;</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        optval = <span class="number">0</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span>(!(env = getenv(<span class="string">"KEEPALIVE"</span>)) || strcasecmp(env, <span class="string">"skip"</span>)) &#123;</div><div class="line">        setsockopt(s, SOL_SOCKET, SO_KEEPALIVE, &amp;optval, <span class="keyword">sizeof</span>(optval));</div><div class="line">      &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> TCP_KEEPCNT</span></div><div class="line">      <span class="keyword">if</span>((env = getenv(<span class="string">"KEEPCNT"</span>)) &amp;&amp; ((optval = atoi(env)) &gt;= <span class="number">0</span>)) &#123;</div><div class="line">        setsockopt(s, SOL_TCP, TCP_KEEPCNT, &amp;optval, <span class="keyword">sizeof</span>(optval));</div><div class="line">      &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> TCP_KEEPIDLE</span></div><div class="line">      <span class="keyword">if</span>((env = getenv(<span class="string">"KEEPIDLE"</span>)) &amp;&amp; ((optval = atoi(env)) &gt;= <span class="number">0</span>)) &#123;</div><div class="line">        setsockopt(s, SOL_TCP, TCP_KEEPIDLE, &amp;optval, <span class="keyword">sizeof</span>(optval));</div><div class="line">      &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> TCP_KEEPINTVL</span></div><div class="line">      <span class="keyword">if</span>((env = getenv(<span class="string">"KEEPINTVL"</span>)) &amp;&amp; ((optval = atoi(env)) &gt;= <span class="number">0</span>)) &#123;</div><div class="line">        setsockopt(s, SOL_TCP, TCP_KEEPINTVL, &amp;optval, <span class="keyword">sizeof</span>(optval));</div><div class="line">      &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">   <span class="keyword">return</span> s;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代码摘取自<code>libkeepalive</code>源码，C语言可以设置更为详细的TCP内核参数</p>
<h3 id="在Nginx中配置"><a href="#在Nginx中配置" class="headerlink" title="在Nginx中配置"></a>在Nginx中配置</h3><p>在Nginx中配置TCP的<code>KeepAlive</code>非常简单，在<code>listen</code>指令下配置<code>so_keepalive</code>就可以了，具体配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">so_keepalive=on|off|[keepidle]:[keepintvl]:[keepcnt]</div></pre></td></tr></table></figure>
<blockquote>
<p>this parameter (1.1.11) configures the “TCP keepalive” behavior for the listening socket. If this parameter is omitted then the operating system’s settings will be in effect for the socket. If it is set to the value “on”, the SO_KEEPALIVE option is turned on for the socket. If it is set to the value “off”, the SO_KEEPALIVE option is turned off for the socket. Some operating systems support setting of TCP keepalive parameters on a per-socket basis using the TCP_KEEPIDLE, TCP_KEEPINTVL, and TCP_KEEPCNT socket options. On such systems (currently, Linux 2.4+, NetBSD 5+, and FreeBSD 9.0-STABLE), they can be configured using the keepidle, keepintvl, and keepcnt parameters. One or two parameters may be omitted, in which case the system default setting for the corresponding socket option will be in effect.</p>
</blockquote>
<p><strong>例子</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">so_keepalive=30m::10</div><div class="line">    will <span class="built_in">set</span> the idle timeout (TCP_KEEPIDLE) to 30 minutes,</div><div class="line">    leave the probe interval (TCP_KEEPINTVL) at its system default,</div><div class="line">    and <span class="built_in">set</span> the probes count (TCP_KEEPCNT) to 10 probes.</div></pre></td></tr></table></figure>
<h2 id="使用的场景"><a href="#使用的场景" class="headerlink" title="使用的场景"></a>使用的场景</h2><p>一般我们使用<code>KeepAlive</code>时会修改空闲时长，避免资源浪费，系统内核会为每一个TCP连接
建立一个保护记录，相对于应用层面效率更高。</p>
<p>常见的几种使用场景：</p>
<ol>
<li>检测挂掉的连接（导致连接挂掉的原因很多，如服务停止、网络波动、宕机、应用重启等）</li>
<li>防止因为网络不活动而断连（使用NAT代理或者防火墙的时候，经常会出现这种问题）</li>
<li>TCP层面的心跳检测</li>
</ol>
<p><code>KeepAlive</code>通过定时发送探测包来探测连接的对端是否存活，
但通常也会许多在业务层面处理的，他们之间的特点：</p>
<ul>
<li>TCP自带的<code>KeepAlive</code>使用简单，发送的数据包相比应用层心跳检测包更小，仅提供检测连接功能</li>
<li>应用层心跳包不依赖于传输层协议，无论传输层协议是TCP还是UDP都可以用</li>
<li>应用层心跳包可以定制，可以应对更复杂的情况或传输一些额外信息</li>
<li><code>KeepAlive</code>仅代表连接保持着，而心跳包往往还代表客户端可正常工作</li>
</ul>
<h2 id="和Http中Keep-Alive的关系"><a href="#和Http中Keep-Alive的关系" class="headerlink" title="和Http中Keep-Alive的关系"></a>和Http中Keep-Alive的关系</h2><ol>
<li>HTTP协议的<code>Keep-Alive</code>意图在于连接复用，同一个连接上串行方式传递请求-响应数据</li>
<li>TCP的<code>KeepAlive</code>机制意图在于保活、心跳，检测连接错误</li>
</ol>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://en.wikipedia.org/wiki/Keepalive" target="_blank" rel="external">Keepalive</a></li>
<li><a href="http://www.tldp.org/HOWTO/html_single/TCP-Keepalive-HOWTO/" target="_blank" rel="external">TCP Keepalive HOWTO</a></li>
<li><a href="http://www.blogjava.net/yongboy/archive/2015/04/14/424413.html" target="_blank" rel="external">随手记之TCP Keepalive笔记</a></li>
<li><a href="http://www.firefoxbug.com/index.php/archives/2805/" target="_blank" rel="external">理解TCP之Keepalive</a></li>
</ul>

        </div>

        <blockquote class="post-copyright">
    <div class="content">
        

        
        原创文章，转载请注明： 转载自<a href="http://biezhi.me" target="_blank">王爵的技术博客</a><br/>本文链接地址：<a href="/2017/08/29/talk-tcp-keepalive.html" target="_blank" rel="external">http://biezhi.me/2017/08/29/talk-tcp-keepalive.html</a>
        
    </div>
    <footer>
        <a href="http://biezhi.me">
            <img src="/img/avatar.png" alt="王爵nice">
            王爵nice
        </a>
    </footer>
</blockquote>

        
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>



        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/keepalive/">keepalive</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/tcp/">tcp</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://biezhi.me/2017/08/29/talk-tcp-keepalive.html&title=《聊聊TCP中的KeepAlive机制》 — 王爵的技术博客&pic=http://biezhi.me/img/avatar.png" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://biezhi.me/2017/08/29/talk-tcp-keepalive.html&title=《聊聊TCP中的KeepAlive机制》 — 王爵的技术博客&source=服务端的系统设置中经常会和底层协议打交道，我们有必要重温一下曾经那些“听过”却不熟悉的名词。
今天聊的话题是 KeepAlive，在实际应用中又是怎么使用的？" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://biezhi.me/2017/08/29/talk-tcp-keepalive.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《聊聊TCP中的KeepAlive机制》 — 王爵的技术博客&url=http://biezhi.me/2017/08/29/talk-tcp-keepalive.html&via=http://biezhi.me" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://biezhi.me/2017/08/29/talk-tcp-keepalive.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between flex-row-reverse">
  

  
    <div class="waves-block waves-effect next">
      <a href="/2017/08/22/lets-30-minutes-write-a-node-cli-application.html" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">30分钟使用Node实现一个命令行程序</h4>
      </a>
    </div>
  
</nav>



    


<section class="comments" id="comments">
    <div id="disqus_thread"></div>
    <script>
    var disqus_shortname = 'biezhi';
    lazyScripts.push('//' + disqus_shortname + '.disqus.com/embed.js')
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>













</article>

<div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        感谢支持 :)
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/img/wechat.png" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check"
                data-wechat="/img/wechat.png" data-alipay="/img/alipay.png">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>博客内容遵循 <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span>王爵nice &copy; 2017</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://biezhi.me/2017/08/29/talk-tcp-keepalive.html&title=《聊聊TCP中的KeepAlive机制》 — 王爵的技术博客&pic=http://biezhi.me/img/avatar.png" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://biezhi.me/2017/08/29/talk-tcp-keepalive.html&title=《聊聊TCP中的KeepAlive机制》 — 王爵的技术博客&source=服务端的系统设置中经常会和底层协议打交道，我们有必要重温一下曾经那些“听过”却不熟悉的名词。
今天聊的话题是 KeepAlive，在实际应用中又是怎么使用的？" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://biezhi.me/2017/08/29/talk-tcp-keepalive.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《聊聊TCP中的KeepAlive机制》 — 王爵的技术博客&url=http://biezhi.me/2017/08/29/talk-tcp-keepalive.html&via=http://biezhi.me" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://biezhi.me/2017/08/29/talk-tcp-keepalive.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACIklEQVR42u3aQY7CMAwFUO5/aWaLhFq+nTCo7ssK0dLkdWEcO49HPJ4v4/2bo/F65/vTkqubBwYGxmUZ+VKOpsx/df65+rIwMDDuxjiKYOdT5s/Jr56H48PvMTAwMIpBM08ocxIGBgZGzqje00NiYGBg9DaxeQqYPOFne3EMDIwLMvKq+/9//kp/AwMD41KMZ3GsUKvltsKqMDAwRjPyANdrbebs3m8xMDDuwKguaO89vdZCFOkxMDAGMXqbyZXEMQ+ySZPg8H8DAwNjHKM6ffXARHK1+hwMDIz7MHa1GPOELw/WzdMiGBgYQxnVEnwey/Oi/4a9OAYGxmhGsmlM0sFvFPWiTSwGBsZoxvrEOb5awlsp3mFgYExi9BaXtwdWan752jAwMGYzqklhdRHJZrU3FwYGxn0YKwG3F3Z7Af3Dy8XAwBjNqJbSei2EXpsh39BiYGDcgbF0aqz4avKy2gYeBgbGUEZeVqtSk2Ne66kqBgbGVMb5RjGZbG8iWD0CgoGBcU9GtRCWh9Ek7C7txTEwMEYz8kLbrsSxl2h+ODmCgYExjvEsjjykni8ueXI5KcTAwBjKWCn0VxO+6jGLvBiHgYFxB8Z6mSyh7m0GRMfCMDAwxjGqk+WxfOU1FQ6CYGBgYMSF+3xx1avlcyIYGBgYxWl6ieN5Y3VDaoiBgXEpRpK69Ur5vVZBuaWKgYExmtHbOvaai9UDHEnYxcDAGM34A2jsk2EWyqNxAAAAAElFTkSuQmCC" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: true };


</script>

<script src="/js/main.min.js?v=1.6.10"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/js/search.min.js?v=1.6.10" async></script>






<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
